
---
title: Android-兼容之图片
date: 2017-11-22 11:20:00
tags:
---

# 关于这个毛茸茸的小错误

最新在开发一个新的 APP ，实现版本更新功能时，出现了覆盖安装的时候，在 Android 7.0 系统上出现解析包错误。

![](http://oriwplcze.bkt.clouddn.com/dc88dc9d5f71ecbff76d988e82228397.png)



报错信息：


![](http://oriwplcze.bkt.clouddn.com/8285ee6fa3afa5ecf2e5fd5809127c03.png)


核心报错信息：

> java.lang.SecurityException: Permission Denial: opening provider android.support.v4.content.FileProvider from ProcessRecord{cc3ad23 16425:com.android.packageinstaller/u0a21} (pid=16425, uid=10021) that is not exported from uid 10340


关于安装失败，案发地点的代码：


```
/*******************错误版***************************／
/**
 * 安装 apk 文件
 * @param apkFile apk 文件
 */
private void installApk(File apkFile){
    Intent intent = new Intent(Intent.ACTION_VIEW);
    Uri apkUri = null;
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) { //判读版本是否在7.0以上
        apkUri = FileProvider.getUriForFile(getActivity(), BuildConfig.APPLICATION_ID + ".fileProvider", apkFile);
        //添加这一句表示对目标应用临时授权该Uri所代表的文件
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
    } else {
        apkUri = Uri.fromFile(apkFile);
    }
    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);

    intent.setDataAndType(apkUri,
            "application/vnd.android.package-archive");
    startActivity(intent);
}

```

当发现是 7.0 系统上才会出现的问题之后，再联系报错信息，很容易就想到 FileProvider 的权限问题，然而并没有什么用，我还是不知道怎么回事。对比之前实现的版本更新的代码，定位到 `intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);` 这句代码，当把这句话注释后是正常。

```
/**
 * 安装 apk 文件
 * @param apkFile apk 文件
 */
private void installApk(File apkFile){
    Intent intent = new Intent(Intent.ACTION_VIEW);
    //放在此处
    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);

    Uri apkUri = null;
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) { //判读版本是否在7.0以上
        apkUri = FileProvider.getUriForFile(getActivity(), BuildConfig.APPLICATION_ID + ".fileProvider", apkFile);
        //添加这一句表示对目标应用临时授权该Uri所代表的文件
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
    } else {
        apkUri = Uri.fromFile(apkFile);
    }


    intent.setDataAndType(apkUri,
            "application/vnd.android.package-archive");
    startActivity(intent);
}

```

# BUG总要有个原因

看一下核心报错

> java.lang.SecurityException: Permission Denial: opening provider android.support.v4.content.FileProvider from ProcessRecord{cc3ad23 16425:com.android.packageinstaller/u0a21} (pid=16425, uid=10021) that is not exported from uid 10340

 这个是权限不足的提示,Android 7.0 之后通过 FileProvider 共享文件，因为 exported为 false，所以需要给目标应用，授予临时权限，加上 Intent.FLAG_GRANT_READ_URI_PERMISSION 参数。

 很明显，我已经加了，但是很不幸，我们在添加之后， `intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK)` 把添加的给替换掉了，因此实际上还是未给权限。

 这是因为对 setFlags() 和 addFlags() 方法认知错误导致的，最后，将 setFlags()操作放在 addFlags() 之前解决了这个问题。


# 知识补充

### intent.setFlags() 和 intent.addFlags() 的区别

setFlags():为intent 设置特殊的标志，会覆盖 intent 已经设置的所有标志。

```
public Intent setFlags(int flags) {
    mFlags = flags;
    return this;
}

```

addFlags():为intent 添加特殊的标志，不会覆盖，只会追加。

```
 public Intent addFlags(int flags) {
     mFlags |= flags;
     return this;
 }

 ```

### Android 7.0 行为变更，通过 FileProvider 在应用中共享文件

Android 7.0 除了提供诸多新特性和功能外，还对系统和 API 行为做出了各种变更。其中有一条，对日常开发的适配影响是非常大的，
- 传递软件包网域外的 file:// URI 可能给接收器留下无法访问的路径。因此，尝试传递 file:// URI 会触发 FileUriExposedException。分享私有文件内容的推荐方法是使用 FileProvider。

FileProvider的使用方法是


### Intent.FLAG_GRANT_READ_URI_PERMISSION & android:grantUriPermissions &  context.grantUriPermission(）三者的区别



### Intent.FLAG_ACTIVITY_NEW_TASK 的意义
